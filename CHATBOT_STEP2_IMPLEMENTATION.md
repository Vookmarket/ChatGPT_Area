# チャットボット実装手順 (ステップ2)

このドキュメントでは、動物病院向け LINE チャットボット＋予約システムにおける **開発手順ステップ2 : チャットボットの基本実装** だけに焦点を当てます。環境準備の詳細は `ENVIRONMENT_SETUP.md` を参照してください。

## 1. Webhook ハンドラ作成
1. Google Apps Script で新しい `doPost(e)` 関数を実装し、LINE から送られてくるメッセージを受信します。
2. `e.postData.contents` をパースしてユーザー ID とメッセージ内容を取得します。
3. Bearer トークンによる認証を行い、正当なリクエストのみ処理します。

## 2. GPT‑4o との連携
1. 受信メッセージをプロンプトとして OpenAI GPT‑4o API に送信します。
2. 得られた回答に免責文を付与し、LINE Messaging API を用いてユーザーへ返信します。
3. 応答生成から返信まで 10 秒以内に完了するよう処理時間に注意します。

## 3. ログ保存
1. 送受信したメッセージ内容と GPT‑4o へのリクエスト・レスポンスを `logs` シートへ記録します。
2. シートの列構成は `time` / `userId` / `direction` / `payload` を基本とします。
3. Apps Script の `SpreadsheetApp` を用いて追記します。

## 4. 重篤ワード判定
1. メッセージ中に危険な症状を示すキーワード (例: \"嘔吐が止まらない\" など) が含まれるか簡易判定します。
2. 該当する場合は自動返信に来院を勧める文面を追加します。

## 5. 予約インテントの抽出
1. GPT‑4o への few‑shot プロンプトで、ユーザーの文章から予約意図を JSON 形式 `{intent,date,time,petInfo}` で抽出させます。
2. `intent` が `create` なら空き枠照会 (`listSlots`) を行い、取得した枠から予約を確定 (`createBooking`) します。
3. `intent` が `cancel` / `update` の場合は `cancelBooking` や `updateBooking` を呼び出して処理します。

## 6. MCP Server との連携
1. 予約処理は MCP Server へ JSON‑RPC でリクエストを送信して実行します。
2. `listSlots` などの結果も `logs` シートへ保存し、レスポンス内容をユーザーへ返します。

## 7. 例外処理とセキュリティ
1. MCP Server からのエラーコードを確認し、ユーザーへ適切なメッセージを返します。
2. リクエストのバリデーションや `LockService` を用いた排他制御など、基本的なセキュリティ対策を実施します。

---
これらの手順を実装することで、LINE 上での質問受付から予約作成・変更までを一貫して行えるチャットボットが完成します。環境構築後はこのステップを中心に開発を進めてください。
